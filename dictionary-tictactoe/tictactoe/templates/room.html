{% load static %}
<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Tictactoe Room</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>

<body>
    <table id="dictionary-table" class="center"></table>
    <table id="palette-table"></table>
    <div>
        <h2>Selected Letter: </h2>
        <h1 style="font-size:192px" id="selectedLetter"></h1>
    </div>

    <script src={% static 'js/util.js' %}></script>
    
    <script>
        class Player{
            constructor(roomSocket, name) {
                this.roomSocket = roomSocket
                this.name = name
            }
            
            set palette(palette) {
                this._palette = palette
                this.syncPaletteData()
            }

            set letter(letter) {
                if (this._palette.includes(letter)){
                    this._selectedLetter = letter
                    this.updateSelectedLetterHtml()
                }
            }

            sendLetter(x, y) {                
                this.roomSocket.send(JSON.stringify({ "type": 100, "x": x, "y": y, "letter" : this._selectedLetter}))
            }

            stealPalette() {                
                this.roomSocket.send(JSON.stringify({ "type": 2}))
            }
            
            updateSelectedLetterHtml() {
                document.querySelector("#selectedLetter").innerHTML = this._selectedLetter
            }            

            syncPaletteData() {
                var row_by_colums_palette_tds = listToMatrix(document.querySelectorAll("#palette-table * > td"), 5)
                let palette = listToMatrix(this._palette, 5)
                var i, j;
                for (i = 0; i < row_by_colums_palette_tds.length; i++) {
                    for (j = 0; j < row_by_colums_palette_tds[i].length; j++) {
                        row_by_colums_palette_tds[i][j].innerHTML = palette[i][j]
                        addSelectLetterEmitter(this, row_by_colums_palette_tds[i][j], row_by_colums_palette_tds[i][j].innerHTML)
                    }
                }
            }
        }

        createTable("dictionary-table", 10,10)
        createTable("palette-table", 2, 5)


        var tds = document.querySelectorAll("#dictionary-table * > td")
        var row_by_column_tds = listToMatrix(tds, 10)

        
        function syncGameData(game_data) {
            var i, j;
            for (i = 0; i < row_by_column_tds.length; i++) {
                for (j = 0; j < row_by_column_tds[i].length; j++) {
                    row_by_column_tds[i][j].innerHTML = game_data[i][j]
                }
            }
        }
        
        function addEmitters(player, td, x, y) {
            td.onclick = () => player.sendLetter(x,y)
        }
        
        function addSelectLetterEmitter(player, td, letter) {
            td.onclick = () => player.letter = letter
        }
        
        var wsStart = window.location.protocol == 'https:' ? 'wss://' : 'ws://'
        
        const roomSocket = new WebSocket(
            wsStart
            + window.location.host
            + '/ws/room/{{room_name}}/'
            );
            
        var player = new Player(roomSocket, "");


        roomSocket.onmessage = (e) => {
            var data = JSON.parse(e.data)
            console.log(data)

            if (data["type"] == 0) {
                player.name = data["message"]["player"]
                player.palette = data["message"]["palette"]
                
                for (var x = 0; x < row_by_column_tds.length; x++) {
                    for (var y = 0; y < row_by_column_tds[x].length; y++) {
                        addEmitters(player, row_by_column_tds[x][y], x, y)
                    }
                }
            }
            else if (data["type"] == 20 || data["type"] == 100) {
                game_data = data["message"]["text"]["game_state"]
                syncGameData(game_data)
            }
            else if (data["type"] == 30) {
                // winner_p.innerHTML = "Winner : " + data["message"]["winner"]
            }

            else if (data["type"] == 200) {
                //player.palette = data["message"]["palette"]
            }
        };
        roomSocket.onclose = (e) => { console.log(e) };
    </script>
</body>

</html>