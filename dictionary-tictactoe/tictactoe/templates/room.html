{% load static %}
<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Tictactoe Room</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>

<body>
    <table id="tictactoe-table" class="center">
        <tr>
            <td id="td1"></td>
            <td id="td2"></td>
            <td id="td3"></td>
        </tr>
        <tr>
            <td id="td4"></td>
            <td id="td5"></td>
            <td id="td6"></td>
        </tr>
        <tr>
            <td id="td7"></td>
            <td id="td8"></td>
            <td id="td9"></td>
        </tr>
    </table>
    <div>
        <p id="current_turn"></p> <br />
        <p id="winner"></p><br />
        <p id="play_as"></p>
    </div>

    <script>
        function listToMatrix(list, elementsPerSubArray) {
            var matrix = [], i, k;

            for (i = 0, k = -1; i < list.length; i++) {
                if (i % elementsPerSubArray === 0) {
                    k++;
                    matrix[k] = [];
                }

                matrix[k].push(list[i]);
            }

            return matrix;
        }

        var tds = document.querySelectorAll("table * > td") // 1x9
        var winner_p = document.querySelector("#winner")
        var play_as_p = document.querySelector("#play_as")
        var current_turn_p = document.querySelector("#current_turn")
        var three_by_three_tds = listToMatrix(tds, 3)

        function syncGameData(game_data) {
            var i, j;
            for (i = 0; i < three_by_three_tds.length; i++) {
                for (j = 0; j < three_by_three_tds[i].length; j++) {
                    three_by_three_tds[i][j].innerHTML = game_data[i][j]
                }
            }
        }

        function addEmitters(roomSocket, td, x, y) {
            td.onclick = () => roomSocket.send(JSON.stringify({ "type": 100, "x": x, "y": y }))
        }


        const roomSocket = new WebSocket(
            'ws://'
            + window.location.host
            + '/ws/room/'
            + "{{room_name}}"
            + '/'
        );

        roomSocket.onmessage = (e) => {
            var data = JSON.parse(e.data)

            console.log(data)
            if (data["type"] == 20 || data["type"] == 100) {
                parsed_text = JSON.parse(data["message"]["text"])
                game_data = parsed_text["game_state"]
                current_turn = parsed_text["current_turn"]
                current_turn_p.innerHTML = "Current Turn : " + current_turn
                winner_p.innerHTML = ""
                syncGameData(game_data)
            }
            else if (data["type"] == 30) {
                winner_p.innerHTML = "Winner : " + data["message"]["winner"]
                current_turn_p.innerHTML = ""
            }

            else if (data["type"] == 0) {
                play_as_p.innerHTML = "You play as : " + data["message"]["player"]
            }
        };
        roomSocket.onclose = (e) => { console.log(e) };

        for (var x = 0; x < three_by_three_tds.length; x++) {
            for (var y = 0; y < three_by_three_tds[x].length; y++) {
                addEmitters(roomSocket, three_by_three_tds[x][y], x, y)
            }
        }
    </script>
</body>

</html>